name: Smoke

on:
  workflow_dispatch:
    inputs:
      scenario:
        description: Scenario to run.
        type: choice
        required: true
        default: archive-missing-bundle-id
        options:
          - archive-missing-bundle-id
          - archive-invalid-key-b64
          - upload-missing-source
          - upload-both-sources
          - split-happy-path
          - split-bundle-mismatch
          - split-bad-app-id
      workspace:
        description: Workspace path used for split E2E scenarios.
        required: false
        default: ""
      scheme:
        description: Scheme used for split E2E scenarios.
        required: false
        default: ""
      app_id:
        description: App Store Connect app ID for split E2E scenarios.
        required: false
        default: ""
      bundle_id:
        description: Expected bundle ID for split E2E scenarios.
        required: false
        default: ""
      asc_team_id:
        description: Team ID for Xcode signing/export.
        required: false
        default: ""
      configuration:
        description: Build configuration.
        required: false
        default: Release
      xcodebuild_extra_args:
        description: Extra xcodebuild archive args.
        required: false
        default: ""

jobs:
  local-negative-tests:
    if: ${{ inputs.scenario == 'archive-missing-bundle-id' || inputs.scenario == 'archive-invalid-key-b64' || inputs.scenario == 'upload-missing-source' || inputs.scenario == 'upload-both-sources' }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Make local test fixtures
        run: |
          mkdir -p FakeApp.xcworkspace
          mkdir -p "${{ runner.temp }}/upload-fixtures"
          touch "${{ runner.temp }}/upload-fixtures/Fake.ipa"

      - name: Scenario archive-missing-bundle-id
        id: archive_missing_bundle
        if: ${{ inputs.scenario == 'archive-missing-bundle-id' }}
        continue-on-error: true
        run: scripts/archive.sh
        env:
          INPUT_WORKSPACE: FakeApp.xcworkspace
          INPUT_SCHEME: FakeScheme
          INPUT_BUNDLE_ID: ""
          INPUT_ASC_KEY_ID: KEYID123
          INPUT_ASC_ISSUER_ID: ISSUER123
          INPUT_ASC_PRIVATE_KEY_B64: Zm9v
          INPUT_ASC_TEAM_ID: TEAM12345
          INPUT_CONFIGURATION: Release
          INPUT_ARCHIVE_PATH: ${{ runner.temp }}/archive/App.xcarchive
          INPUT_EXPORT_PATH: ${{ runner.temp }}/export
          INPUT_XCODEBUILD_EXTRA_ARGS: ""

      - name: Assert archive-missing-bundle-id failed
        if: ${{ inputs.scenario == 'archive-missing-bundle-id' }}
        run: |
          if [[ "${{ steps.archive_missing_bundle.outcome }}" != "failure" ]]; then
            echo "Expected archive-missing-bundle-id scenario to fail."
            exit 1
          fi

      - name: Scenario archive-invalid-key-b64
        id: archive_invalid_key
        if: ${{ inputs.scenario == 'archive-invalid-key-b64' }}
        continue-on-error: true
        run: scripts/archive.sh
        env:
          INPUT_WORKSPACE: FakeApp.xcworkspace
          INPUT_SCHEME: FakeScheme
          INPUT_BUNDLE_ID: com.example.app
          INPUT_ASC_KEY_ID: KEYID123
          INPUT_ASC_ISSUER_ID: ISSUER123
          INPUT_ASC_PRIVATE_KEY_B64: "###-NOT-BASE64-###"
          INPUT_ASC_TEAM_ID: TEAM12345
          INPUT_CONFIGURATION: Release
          INPUT_ARCHIVE_PATH: ${{ runner.temp }}/archive/App.xcarchive
          INPUT_EXPORT_PATH: ${{ runner.temp }}/export
          INPUT_XCODEBUILD_EXTRA_ARGS: ""

      - name: Assert archive-invalid-key-b64 failed
        if: ${{ inputs.scenario == 'archive-invalid-key-b64' }}
        run: |
          if [[ "${{ steps.archive_invalid_key.outcome }}" != "failure" ]]; then
            echo "Expected archive-invalid-key-b64 scenario to fail."
            exit 1
          fi

      - name: Scenario upload-missing-source
        id: upload_missing_source
        if: ${{ inputs.scenario == 'upload-missing-source' }}
        continue-on-error: true
        run: scripts/upload.sh
        env:
          INPUT_APP_ID: "123456789"
          INPUT_ASC_KEY_ID: KEYID123
          INPUT_ASC_ISSUER_ID: ISSUER123
          INPUT_ASC_PRIVATE_KEY_B64: Zm9v
          INPUT_IPA_PATH: ""
          INPUT_ARTIFACT_NAME: ""
          INPUT_ARTIFACT_DOWNLOAD_PATH: ${{ runner.temp }}/upload-fixtures
          INPUT_WAIT_FOR_PROCESSING: "false"
          INPUT_POLL_INTERVAL: 30s

      - name: Assert upload-missing-source failed
        if: ${{ inputs.scenario == 'upload-missing-source' }}
        run: |
          if [[ "${{ steps.upload_missing_source.outcome }}" != "failure" ]]; then
            echo "Expected upload-missing-source scenario to fail."
            exit 1
          fi

      - name: Scenario upload-both-sources
        id: upload_both_sources
        if: ${{ inputs.scenario == 'upload-both-sources' }}
        continue-on-error: true
        run: scripts/upload.sh
        env:
          INPUT_APP_ID: "123456789"
          INPUT_ASC_KEY_ID: KEYID123
          INPUT_ASC_ISSUER_ID: ISSUER123
          INPUT_ASC_PRIVATE_KEY_B64: Zm9v
          INPUT_IPA_PATH: ${{ runner.temp }}/upload-fixtures/Fake.ipa
          INPUT_ARTIFACT_NAME: Smoke.ipa
          INPUT_ARTIFACT_DOWNLOAD_PATH: ${{ runner.temp }}/upload-fixtures
          INPUT_WAIT_FOR_PROCESSING: "false"
          INPUT_POLL_INTERVAL: 30s

      - name: Assert upload-both-sources failed
        if: ${{ inputs.scenario == 'upload-both-sources' }}
        run: |
          if [[ "${{ steps.upload_both_sources.outcome }}" != "failure" ]]; then
            echo "Expected upload-both-sources scenario to fail."
            exit 1
          fi

  split-archive:
    if: ${{ inputs.scenario == 'split-happy-path' || inputs.scenario == 'split-bundle-mismatch' || inputs.scenario == 'split-bad-app-id' }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run archive action
        id: archive_step
        continue-on-error: true
        uses: ./actions/archive
        with:
          workspace: ${{ inputs.workspace }}
          scheme: ${{ inputs.scheme }}
          bundle_id: ${{ inputs.scenario == 'split-bundle-mismatch' && format('{0}.mismatch', inputs.bundle_id) || inputs.bundle_id }}
          asc_key_id: ${{ secrets.ASC_KEY_ID }}
          asc_issuer_id: ${{ secrets.ASC_ISSUER_ID }}
          asc_private_key_b64: ${{ secrets.ASC_PRIVATE_KEY_B64 }}
          asc_team_id: ${{ inputs.asc_team_id }}
          configuration: ${{ inputs.configuration }}
          xcodebuild_extra_args: ${{ inputs.xcodebuild_extra_args }}

      - name: Assert archive scenario result
        run: |
          outcome="${{ steps.archive_step.outcome }}"
          scenario="${{ inputs.scenario }}"

          if [[ "${scenario}" == "split-bundle-mismatch" ]]; then
            [[ "${outcome}" == "failure" ]] || { echo "split-bundle-mismatch should fail in archive stage."; exit 1; }
          else
            [[ "${outcome}" == "success" ]] || { echo "${scenario} should pass archive stage."; exit 1; }
          fi

      - name: Upload IPA artifact for upload job
        if: ${{ inputs.scenario != 'split-bundle-mismatch' && steps.archive_step.outcome == 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: Smoke.ipa
          path: ${{ steps.archive_step.outputs.ipa_path }}
          if-no-files-found: error

  split-upload:
    if: ${{ inputs.scenario == 'split-happy-path' || inputs.scenario == 'split-bad-app-id' }}
    needs: split-archive
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run upload action (artifact mode)
        id: upload_step
        continue-on-error: true
        uses: ./actions/upload
        with:
          app_id: ${{ inputs.scenario == 'split-bad-app-id' && '0000000000' || inputs.app_id }}
          asc_key_id: ${{ secrets.ASC_KEY_ID }}
          asc_issuer_id: ${{ secrets.ASC_ISSUER_ID }}
          asc_private_key_b64: ${{ secrets.ASC_PRIVATE_KEY_B64 }}
          artifact_name: Smoke.ipa
          artifact_download_path: ${{ runner.temp }}/smoke-upload
          wait_for_processing: "false"

      - name: Assert upload scenario result
        run: |
          outcome="${{ steps.upload_step.outcome }}"
          scenario="${{ inputs.scenario }}"

          if [[ "${scenario}" == "split-happy-path" ]]; then
            [[ "${outcome}" == "success" ]] || { echo "split-happy-path should succeed."; exit 1; }
          else
            [[ "${outcome}" == "failure" ]] || { echo "split-bad-app-id should fail in upload stage."; exit 1; }
          fi
